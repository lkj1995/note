### 带宽(kHz)
- 在现代网络技术中，人们总是以“带宽”来表示信道的数据传输速率，“带宽”与“速率”几乎成了同义词。信道带宽与数据传输速率的关系可以奈奎斯特(Nyquist)准则与香农(Shanon)定律描述。
- 奈奎斯特准则指出：如果间隔为π/ω(ω=2πf),即1/2f，通过理想通信信道传输窄脉冲信号，则前后码元之间不产生相互窜扰。因此，对于二进制数据信号的最大数据传输速率Rmax与通信信道带宽B（B = f,单位Hz)的关系可以写为：Rmax＝2B(bps)
- 对于二进制数据，若信道带宽B = f = 3000Hz，则最大数据传输速率为6000bps，也即信道带宽是数据传输速率的1/2。
- 香农定理：在有随机热噪声的信道上传输数据信号时，数据传输速率Rmax与信道带宽B、信噪比S/N的关系为：
  - Rmax = Blog2(1 + S/N)
- Rmax单位为bps,带宽B单位为Hz，信噪比S/N通常以dB（分贝）数表示。若S/N=30(dB),那么信噪比根据公式：
  - S/N(dB)=10lg(S/N)
- 可得，S/N＝1000。若带宽B=3000Hz，则Rmax≈20kbps。香农定律给出了一个有限带宽、有热噪声信道的最大数据传输速率的极限值。它表示对于带宽只有3000Hz的通信信道，信噪比在30db时，无论数据采用二进制或更多的离散电平值表示，都不能用越过20kbps的速率传输数据。
- 因此通信信道最大传输速率与信道带宽之间存在着明确的关系，所以人们可以用“带宽”去取代“速率”。例如，人们常把网络的“高数据传输速率”用网络的“高带宽”去表述。因此“带宽”与“速率”在网络技术的讨论中几乎成了同义词。

### 扩频因子

- 通俗的说，扩频时你的数据每一位都和扩频因子相乘，例如有一个1 bit需要传送，当扩频因子为1时，传输的时候数据1就用一个1来表示，扩频因子为6时（有6位）111111，这111111就来表示1，这样乘出来每一位都由一个6位的数据来表示，也就是说需要传输总的数据量增大了6倍。
- 这样扩频后传输可以降低误码率也就是信噪比，但是在同样数据量条件下却减少了可以传输的实际数据，所以，扩频因子越大，传输的数据数率（比特率）就越小。
- 纠错编码率：是数据流中有用部分（非冗余）的比例。也就是说，如果编码率是k/n，则对每k位有用信息，编码器总共产生n位的数据，其中n-k是多余的
- 标称比特率(bps)：每秒发送的比特数
- 灵敏度(dBm)
  - 就是接收机能够正确地把有用信号拿出来的最小信号接收功率，最小接收功率的值越小灵敏度就越高，例如接收灵敏度为-147dBm就比-96dBm的灵敏度要高得多，因为理想条件下前者能够接收并能够正常处理更弱的信号。
 - 无线传输的接收灵敏度类似于人们沟通交谈时的听力，提高信号的接收灵敏度可使无线产品具有更强地捕获弱信号的能力。这样，随着传输距离的增加，接收信号变弱，高灵敏度的无线产品仍可以接收数据，维持稳定连接，大幅提高传输距离。
- 参考频率
  -TCXO：温度补偿晶体振荡器，单端输出
  -XTAL：晶体振荡器，双端输出
- 信道：信息传输的通道
  - GMSK：
- 频谱：频率谱密度，复杂振荡分解为振幅不同和频率不同的谐振荡，这些谐振荡的幅值按频率排列的图形叫做频谱，则它的频谱密度S（w）可以由傅里叶变换求得。
- 码片：一个数据信号（如逻辑1或0）通常要用多个编码信号来进行编码，那么其中的一个编码信号就称为一个码片，即一个比特再分割为多个码片
  -码片速率 / 标称比特率 = 扩频因子
- 信噪比：信号的平均功率和噪声的平均功率之比 S / N ，如信噪比越大，信息的传输速率就越高
  - 信噪比（dB）= 10 * log10(S/N) (dB)
- 前向纠错：接收端利用发送端在发送码元序列中加入的差错控制码元,不但能够发现错码,还能将错码恢复其正确取值。
- 码元
  - 一个码元就是一个脉冲信号，一个脉冲信号有可能携带1bit数据，也有可能携带2bit数据、4bit数据。
  - 你发送一个脉冲信号，如果就可以携带4bit数据，肯定发送速率更快啊！那么怎么实现一个脉冲信号就能携带多个bit数据呢？就需要一定的技术了，比如设置模拟信号中信号的频率、相位、振幅啥的。举个例子：把振幅分成四种，低（00）、中（01）、高（10）、很高（11），这样我发一个脉冲信号，它的振幅是低，那就说明发送的是00（也就是2bit），它的振幅是中（01），发送的就是01（也就是2bit）……也就实现了一个脉冲信号，携带2bit的功能。

![img](.\img\lora_bit.jpg)



- LoRa数据包

![img](.\img\lora_format.jpg)

- 公式(Rs(符号速率)  Rb(比特速率) Rc(码片速率)  SF(扩频因子) )         
  - BW = Rc    如 BW = 125kHz BW = Rc = 125000 (chips / s)        
  - Rs = BW / (2 ^ SF)        
  - Rb = SF * (BW / (2 ^ SF)) * 4 / (4 + CR)
- LNA：低噪声放大器
- AGC：自动增益控制
- AFC：自动频率矫正
- RSSI：接收信号强度指示
- TLS：顶级定序器

#### 配置1
- 拉低RESET，等待xx毫秒，拉高RESET，完成复位
- 读取某个寄存器，确认复位成功
- 进入休眠模式，设置调解模式为LoRa            
  -寄存器：0x01
- 设置Frf(射频载波频率)                                     
  -  寄存器：0x06 ~ 0x08
  - FXOSC(晶振频率) = 【32 MHz】
  - Fstep(频率合成器步长) = FXOSC / (2 ^ 19) = 32 000 000 / 524288 = 61.0352
  - Frf = Fstep * Frf(23 ; 0) 
  - 如需 Frf = 【434MHz】
  - 则 Frf(23 ; 0) = Frf / Fstep = 434 000 000 / 61.0352 = 7110656 = 0x006C 8000
- 设置带宽(BW) 和纠错编码率(CR)                
  - 寄存器：0x1D
- 设置码片，CRC                            
  -  寄存器：0x1E[7 : 2]
- RX超时时间                                    
  - 寄存器：0x1E[1 : 0] ~ 0x1F
- 设置功率                                         
  - 寄存器：0x09
  - Pmax = 10.8 + 0.6 * MaxPower【dbm】
- 设置过流保护(OcpTrim)                
  - 寄存器：0x0B
  - OcpTrim <= 15        Imax = 45 + 5 * OcpTrim【mA】
  - 15 < OcpTrim <= 27    Imax = -30 + 10 * OcpTrim【mA】
- 设置PreambleLength(前导码长度有效位)        
  - 寄存器：0x20 ~ 0x21



#### 发送操作
- 进入待机模式
- TX 初始化，配置好寄存器
- 
  - 将FifoPtrAddr设置为FifoTxPtrBase
  - PayloadLength字节写入FIFO (RegFifo)
  - 写入数据到FIFO
- 切换为发送模式
- 等待发送完成中断，会自动切换到待机模式
- 如果还有数据要发，重复3步骤

![img](.\img\lora_send.jpg)

#### 接收操作
- 进入待机模式
- RX 初始化，配置好寄存器
- 单次模式：接收到数据或超时，会回到待机模式
- 连续模式，接收到数据，产生中断，读取完成后，又重新等待数据

![img](.\img\lora_recv.jpg)

#### 配置初始化
```C
    { MODEM_FSK , REG_LNA                , 0x23 },\
    { MODEM_FSK , REG_RXCONFIG           , 0x1E },\
    { MODEM_FSK , REG_RSSICONFIG         , 0xD2 },\
    { MODEM_FSK , REG_AFCFEI             , 0x01 },\
    { MODEM_FSK , REG_PREAMBLEDETECT     , 0xAA },\
    { MODEM_FSK , REG_OSC                , 0x07 },\
    { MODEM_FSK , REG_SYNCCONFIG         , 0x12 },\
    { MODEM_FSK , REG_SYNCVALUE1         , 0xC1 },\
    { MODEM_FSK , REG_SYNCVALUE2         , 0x94 },\
    { MODEM_FSK , REG_SYNCVALUE3         , 0xC1 },\
    { MODEM_FSK , REG_PACKETCONFIG1      , 0xD8 },\
    { MODEM_FSK , REG_FIFOTHRESH         , 0x8F },\
    { MODEM_FSK , REG_IMAGECAL           , 0x02 },\
    { MODEM_FSK , REG_DIOMAPPING1        , 0x00 },\
    { MODEM_FSK , REG_DIOMAPPING2        , 0x30 },\
    { MODEM_LORA, REG_LR_PAYLOADMAXLENGTH, 0x40 },\
```

#### 配置发送
##### 初始化的发送配置
- 进入睡眠状态，设置为LoRa调制           
  - 寄存器：0x01
- 配置使用PABOOST引脚，此时最大功率为   
  - 寄存器：0x09
  - Pout = 17 - (15 - OutputPower)  与MaxPower部分无关           
- 使能在PA_BOOST引脚输出+20dBm        
  - 寄存器：0x4D
- 设置带宽和纠错编码率，显式报头          
  - 寄存器：0x1D
- 设置码片，单次发送模式，开启CRC校验    
  - 寄存器：0x1E            
- 配置同步帧头长度                       
  - 寄存器：0x20  0x21 

##### 设置发送模式
- 设置数据的长度                    
  - 寄存器：0x22
- 设置发送调制器的发送开始地址，设置SPI要开始写入的地址     
  -  寄存器：0x0E    0x0D
- 保证当前在待机状态                     
  - 寄存器：0x01                 
- 把数据写入FIFO                        
  - 寄存器：0x00
- 中断屏蔽设置，只使能发送完成中断         
  - 寄存器：0x11
- 调整DIO0引脚为发送完成中断触发          
  - 寄存器：0x40
- 设置为发送模式                        
  -  寄存器：0x01
- 随便读取一个寄存器，开始发送 
- 等待触发中断，发送完成后，立马调整到接收模式

#### 配置接收
##### 初始化的接收配置 
- 和发送一样，一起配置就好
- 进入睡眠状态，设置为LoRa调制           
  - 寄存器：0x01
- 配置使用PABOOST引脚，此时最大功率为   
  - 寄存器：0x09
  - Pout=17-(15-OutputPower)  与MaxPower部分无关           
- 使能在PA_BOOST引脚输出+20dBm       
  -  寄存器：0x4D
- 设置带宽和纠错编码率，显式报头          
  - 寄存器：0x1D
- 设置码片，单次发送模式，开启CRC校验   
  - 寄存器：0x1E            
- 配置同步帧头长度                       
  - 寄存器：0x20  0x21 

##### 2.设置接收模式
- 中断屏蔽设置，使能接收中断和CRC校验错误（如果连续模式错误会怎么处理的？） 
  - 寄存器 0x11
- 调整DIO0引脚为接收中断触发，调整DIO3引脚为CRC错误触发                   
  - 寄存器：0x40
- 接收调制器的写入地址，设置SPI要读取的地址           
  - 寄存器：0x0F 0x0D
- 设置为连续接收模式                               
  - 寄存器：0x01
- 随便读取一个寄存器，开始接收  
- 等待触发中断，接收后，立马复制到帧